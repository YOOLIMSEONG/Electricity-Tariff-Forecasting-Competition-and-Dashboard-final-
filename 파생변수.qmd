---
title: "LS ì „ë ¥ ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ì „ê¸°ìš”ê¸ˆ ì˜ˆì¸¡ - ë°ì´í„° íƒìƒ‰"
author: "ê¹€ë™ê· "
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    theme: cosmo
execute:
  echo: true
  warning: false
  message: false
---

#  í”„ë¡œì íŠ¸ ê°œìš”

ì´ ë¬¸ì„œëŠ” **LS ì „ë ¥ ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ì „ê¸°ìš”ê¸ˆ ì˜ˆì¸¡ ëŒ€íšŒ**ì˜ ì²« ë²ˆì§¸ ë‹¨ê³„ë¡œ,  
ê¸°ë³¸ ë°ì´í„°ì…‹ êµ¬ì¡° ë° ê²°ì¸¡ì¹˜, ì´ìƒì¹˜, í†µê³„ì  íŠ¹ì§• ë“±ì„ í™•ì¸í•˜ê¸° ìœ„í•œ ë°ì´í„° íƒìƒ‰(EDA) ëª©ì ì„ ê°€ì§„ë‹¤.

---

#  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°

```{python}
import pandas as pd
import numpy as np
import holidays

# ë°ì´í„° ë¡œë“œ
train = pd.read_csv("./data/train.csv")

# ë°ì´í„° í¬ê¸° í™•ì¸
print("ë°ì´í„° í¬ê¸°:", train.shape)
print(train.head())
```

# ì‹œê°„ ì™¸ìƒ ë³€ìˆ˜

## ì£¼ê¸°ì„± ì¸ì½”ë”© (ì¼/ì£¼ ì£¼ê¸°)

```{python}

df = pd.read_csv("./data/test.csv")

# ë‚ ì§œí˜•ìœ¼ë¡œ ë³€í™˜

df["ì¸¡ì •ì¼ì‹œ"] = pd.to_datetime(df["ì¸¡ì •ì¼ì‹œ"])
df = df.sort_values("ì¸¡ì •ì¼ì‹œ").reset_index(drop=True)

print("âœ… ë°ì´í„° í¬ê¸°:", df.shape)
df.head(3)
#ë‚ ì§œí˜•ìœ¼ë¡œ ë³€í™˜

df["ì¸¡ì •ì¼ì‹œ"] = pd.to_datetime(df["ì¸¡ì •ì¼ì‹œ"])
df = df.sort_values("ì¸¡ì •ì¼ì‹œ").reset_index(drop=True)

df["year"] = df["ì¸¡ì •ì¼ì‹œ"].dt.year
df["month"] = df["ì¸¡ì •ì¼ì‹œ"].dt.month
df["day"] = df["ì¸¡ì •ì¼ì‹œ"].dt.day
df["hour"] = df["ì¸¡ì •ì¼ì‹œ"].dt.hour
df["minute"] = df["ì¸¡ì •ì¼ì‹œ"].dt.minute

# ìš”ì¼, ì£¼ë§ ì—¬ë¶€

df["day_of_week"] = df["ì¸¡ì •ì¼ì‹œ"].dt.dayofweek  # 0=ì›”, 6=ì¼
df["is_weekend"] = (df["day_of_week"] >= 5).astype(int)

# í•˜ë£¨ 15ë¶„ ë‹¨ìœ„ êµ¬ê°„ ì¸ë±ìŠ¤ (0~95)

df["q15_index"] = (df["hour"] * 60 + df["minute"]) // 15


```

## ì£¼ê¸°ì„± ì¸ì½”ë”© (ì¼/ì£¼ ì£¼ê¸°)


```{python}

# í•˜ë£¨ ì£¼ê¸° (96ìŠ¬ë¡¯)

df["sin_day"] = np.sin(2 * np.pi * df["q15_index"] / 96)
df["cos_day"] = np.cos(2 * np.pi * df["q15_index"] / 96)

# ì£¼ê°„ ì£¼ê¸° (7ì¼ Ã— 96ìŠ¬ë¡¯)

df["sin_week"] = np.sin(2 * np.pi * (df["day_of_week"] * 96 + df["q15_index"]) / (7 * 96))
df["cos_week"] = np.cos(2 * np.pi * (df["day_of_week"] * 96 + df["q15_index"]) / (7 * 96))

```

## ê³„ì ˆ êµ¬ë¶„


```{python}

def get_season(month):
    if month in [12, 1, 2]:
        return "winter"
    elif month in [3, 4, 5]:
        return "spring"
    elif month in [6, 7, 8]:
        return "summer"
    else:
        return "autumn"

df["season"] = df["month"].apply(get_season)


```

## ğŸ‡°ğŸ‡· í•œêµ­ ê³µíœ´ì¼ í”¼ì²˜ ì¶”ê°€


```{python}

# holidays ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ í•œêµ­ ê³µíœ´ì¼ ê°ì²´ ìƒì„±

kr_holidays = holidays.KR()

# ê³µíœ´ì¼ ì—¬ë¶€ (1=ê³µíœ´ì¼, 0=í‰ì¼)

df["is_holiday"] = df["ì¸¡ì •ì¼ì‹œ"].dt.date.apply(lambda x: int(x in kr_holidays))

# í™•ì¸

print("ê³µíœ´ì¼ ì˜ˆì‹œ:", list(kr_holidays.items())[:5])
df[["ì¸¡ì •ì¼ì‹œ", "day_of_week", "is_weekend", "is_holiday"]].head(10)


```

## ê²°ê³¼ í™•ì¸


```{python}

cols = [
"ì¸¡ì •ì¼ì‹œ", "hour", "day_of_week", "is_weekend", "is_holiday",
"q15_index", "sin_day", "cos_day", "sin_week", "cos_week", "season"
]
df[cols].head(20)


```

## ê²°ê³¼ ì €ì¥

```{python}

output_path = "./data/train_time_features.csv"
df.to_csv(output_path, index=False, encoding="utf-8-sig")

```


# ì½”ë“œ: ìœ„ì¹˜ê¸°ë°˜ ë‚ ì”¨ ë°ì´í„° + ì‹œê°„ ë§¤ì¹­ í†µí•©


```{python}
import pandas as pd
import requests

# ---------------------------------------
# 1ï¸âƒ£ ê¸°ë³¸ ì„¤ì •
# ---------------------------------------
LAT, LON = 36.65070, 127.44550  # ì²­ì£¼ì‹œ í¥ë•êµ¬ ë°±ë´‰ë¡œ 95
PATH_TRAIN = "./data/train_time_features.csv"
OUTPUT_PATH = "./data/fixed_train_weather_full.csv"

# ---------------------------------------
# 2ï¸âƒ£ train ê¸°ê°„ í™•ì¸
# ---------------------------------------
df = pd.read_csv(PATH_TRAIN)
df["ì¸¡ì •ì¼ì‹œ"] = pd.to_datetime(df["ì¸¡ì •ì¼ì‹œ"])
start_date = df["ì¸¡ì •ì¼ì‹œ"].min().strftime("%Y-%m-%d")
end_date = df["ì¸¡ì •ì¼ì‹œ"].max().strftime("%Y-%m-%d")

print(f"ğŸ“† ê¸°ê°„: {start_date} ~ {end_date}")

# ---------------------------------------
# 3ï¸âƒ£ Open-Meteo API í˜¸ì¶œ ì¤€ë¹„
# ---------------------------------------
url = "https://archive-api.open-meteo.com/v1/archive"

params = {
    "latitude": LAT,
    "longitude": LON,
    "start_date": start_date,
    "end_date": end_date,
    "hourly": [
        # ğŸŒ¡ï¸ ì˜¨ë„Â·ìŠµë„ ê´€ë ¨
        "temperature_2m", "apparent_temperature", "dew_point_2m", "relative_humidity_2m",
        # ğŸŒ§ï¸ ê°•ìˆ˜Â·ë‚ ì”¨
        "precipitation", "rain", "snowfall", "weathercode",
        # ğŸŒ¬ï¸ í’ì†Â·í’í–¥
        "windspeed_10m", "winddirection_10m", "windgusts_10m",
        # â˜ï¸ êµ¬ë¦„Â·ì¼ì‚¬Â·ê¸°ì••
        "cloudcover", "shortwave_radiation", "surface_pressure", "sunshine_duration"
    ],
    "timezone": "Asia/Seoul"
}

# ---------------------------------------
# 4ï¸âƒ£ API ìš”ì²­ ë° ë³€í™˜
# ---------------------------------------
print("ğŸŒ¤ï¸ Open-Meteo ë°ì´í„° ìš”ì²­ ì¤‘...")
response = requests.get(url, params=params)
data = response.json()

if "hourly" not in data:
    raise ValueError("âŒ API ì‘ë‹µì— hourly ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„ì´ë‚˜ ìœ„ê²½ë„ í™•ì¸ í•„ìš”.")

weather = pd.DataFrame(data["hourly"])
weather["time"] = pd.to_datetime(weather["time"])

# ì»¬ëŸ¼ëª… í•œê¸€í™”
rename_dict = {
    "time": "ì¸¡ì •ì¼ì‹œ",
    "temperature_2m": "ê¸°ì˜¨(Â°C)",
    "apparent_temperature": "ì²´ê°ì˜¨ë„(Â°C)",
    "dew_point_2m": "ì´ìŠ¬ì (Â°C)",
    "relative_humidity_2m": "ìŠµë„(%)",
    "precipitation": "ì´ê°•ìˆ˜ëŸ‰(mm)",
    "rain": "ë¹„(mm)",
    "snowfall": "ì ì„¤(cm)",
    "weathercode": "ë‚ ì”¨ì½”ë“œ",
    "windspeed_10m": "í’ì†(m/s)",
    "winddirection_10m": "í’í–¥(Â°)",
    "windgusts_10m": "ëŒí’(m/s)",
    "cloudcover": "êµ¬ë¦„ëŸ‰(%)",
    "shortwave_radiation": "ë‹¨íŒŒë³µì‚¬(W/mÂ²)",
    "surface_pressure": "ê¸°ì••(hPa)",
    "sunshine_duration": "ì¼ì¡°ì‹œê°„(s)"
}
weather.rename(columns=rename_dict, inplace=True)

print("âœ… ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:", weather.shape)

# ---------------------------------------
# 5ï¸âƒ£ ì‹œê°„ ë§¤ì¹­ (1ì‹œê°„ â†’ 15ë¶„ ë‹¨ìœ„ ë³‘í•©)
# ---------------------------------------
df["ì¸¡ì •ì¼ì‹œ_ì •ì‹œ"] = df["ì¸¡ì •ì¼ì‹œ"].dt.floor("H")

merged = pd.merge_asof(
    df.sort_values("ì¸¡ì •ì¼ì‹œ_ì •ì‹œ"),
    weather.sort_values("ì¸¡ì •ì¼ì‹œ"),
    left_on="ì¸¡ì •ì¼ì‹œ_ì •ì‹œ",
    right_on="ì¸¡ì •ì¼ì‹œ",
    direction="nearest"
)

merged.drop(columns=["ì¸¡ì •ì¼ì‹œ_ì •ì‹œ"], inplace=True)

# ---------------------------------------
# 6ï¸âƒ£ ì €ì¥
# ---------------------------------------
merged.to_csv(OUTPUT_PATH, index=False, encoding="utf-8-sig")
print(f"âœ… ìµœì¢… íŒŒì¼ ì €ì¥ ì™„ë£Œ: {OUTPUT_PATH}")
print("ğŸ“Š ìµœì¢… ë°ì´í„° í¬ê¸°:", merged.shape)

# ë¯¸ë¦¬ë³´ê¸°
print(merged.head(5))


```

# train ê³¼ test ì»¬ëŸ¼ ì°¨ì´

```{python}
import pandas as pd

# ---------------------------------------
# 1ï¸âƒ£ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
# ---------------------------------------
path = "./data/fixed_train_weather_full.csv"
df = pd.read_csv(path)
print("ğŸ“‚ ì›ë³¸ ë°ì´í„° í¬ê¸°:", df.shape)

# ---------------------------------------
# 2ï¸âƒ£ ì œê±° ëŒ€ìƒ ì»¬ëŸ¼ ì •ì˜
# ---------------------------------------
remove_cols = [
    "carbon_per_kWh",    # íƒ„ì†Œë°°ì¶œëŸ‰ íŒŒìƒ
    "kVAh",              # ì „ë ¥ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ê³„ì‚°
    "kW_15m",            # ë‹¨ìˆœ ë°°ìˆ˜ ë³€í™˜
    "pf_avg",            # í‰ê·  ì—­ë¥  (ì§€ìƒ/ì§„ìƒì—ì„œ íŒŒìƒ)
    "pf_low_flag",       # ì—­ë¥  í”Œë˜ê·¸ (íŒŒìƒ)
    "íƒ„ì†Œë°°ì¶œëŸ‰(tCO2)"   # carbon_per_kWhì™€ ì¤‘ë³µ
]

# ---------------------------------------
# 3ï¸âƒ£ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ í•„í„°ë§ í›„ ì œê±°
# ---------------------------------------
cols_to_drop = [c for c in remove_cols if c in df.columns]
df = df.drop(columns=cols_to_drop, errors="ignore")

print(f"ğŸ§¹ ì œê±°ëœ ì»¬ëŸ¼: {cols_to_drop}")
print("ğŸ“Š ì •ë¦¬ í›„ ë°ì´í„° í¬ê¸°:", df.shape)

# ---------------------------------------
# 4ï¸âƒ£ ì¤‘ë³µ ì»¬ëŸ¼ ì´ë¦„ ìë™ ì œê±° (merge ì‹œ ìƒê¸´ ì¤‘ë³µ ë“±)
# ---------------------------------------
df = df.loc[:, ~df.columns.duplicated()]

# ---------------------------------------
# 5ï¸âƒ£ ì €ì¥
# ---------------------------------------
output_path = "./data/fixed_train_clean.csv"
df.to_csv(output_path, index=False, encoding="utf-8-sig")

print(f"âœ… ìµœì¢… ì •ë¦¬ ì™„ë£Œ: {output_path}")

```

```{python}


import pandas as pd

# íŒŒì¼ ê²½ë¡œ ì§€ì •
train_path = "./data/fixed_train_clean.csv"
test_path = "./data/fixed_test_weather_full.csv"

# íŒŒì¼ ì½ê¸°
train = pd.read_csv(train_path)
test = pd.read_csv(test_path)

# ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
train_cols = set(train.columns)
test_cols = set(test.columns)

# ì°¨ì´ ë¹„êµ
only_in_train = train_cols - test_cols
only_in_test = test_cols - train_cols
common_cols = train_cols & test_cols

print("âœ… ê³µí†µ ì»¬ëŸ¼ ê°œìˆ˜:", len(common_cols))
print("âœ… ê³µí†µ ì»¬ëŸ¼:", sorted(list(common_cols)))
print("\nâŒ trainì—ë§Œ ìˆëŠ” ì»¬ëŸ¼:", sorted(list(only_in_train)))
print("\nâŒ testì—ë§Œ ìˆëŠ” ì»¬ëŸ¼:", sorted(list(only_in_test)))


```